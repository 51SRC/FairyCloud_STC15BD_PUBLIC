C51 COMPILER V8.02   SMARTCAR                                                              07/12/2020 13:06:10 PAGE 1   


C51 COMPILER V8.02, COMPILATION OF MODULE SMARTCAR
OBJECT MODULE PLACED IN ..\hex\SmartCar.obj
COMPILER INVOKED BY: C:\Keil\C51\BIN\C51.EXE ..\code\SmartCar.c PRINT(.\SmartCar.lst) TABS(2) OBJECT(..\hex\SmartCar.obj
                    -)

line level    source

   1          /*---------------------------------------------------------------------*/
   2          /* --- STC MCU Limited ------------------------------------------------*/
   3          /* --- STC15F4K60S4 ÏµÁÐ ¶¨Ê±Æ÷1ÓÃ×÷´®¿Ú1µÄ²¨ÌØÂÊ·¢ÉúÆ÷¾ÙÀý------------*/
   4          /* --- Mobile: (86)13922805190 ----------------------------------------*/
   5          /* --- Fax: 86-0513-55012956,55012947,55012969 ------------------------*/
   6          /* --- Tel: 86-0513-55012928,55012929,55012966-------------------------*/
   7          /* --- Web: www.STCMCU.com --------------------------------------------*/
   8          /* --- Web: www.GXWMCU.com --------------------------------------------*/
   9          /* Èç¹ûÒªÔÚ³ÌÐòÖÐÊ¹ÓÃ´Ë´úÂë,ÇëÔÚ³ÌÐòÖÐ×¢Ã÷Ê¹ÓÃÁËSTCµÄ×ÊÁÏ¼°³ÌÐò        */
  10          /* Èç¹ûÒªÔÚÎÄÕÂÖÐÓ¦ÓÃ´Ë´úÂë,ÇëÔÚÎÄÕÂÖÐ×¢Ã÷Ê¹ÓÃÁËSTCµÄ×ÊÁÏ¼°³ÌÐò        */
  11          /*---------------------------------------------------------------------*/
  12          
  13          //±¾Ê¾ÀýÔÚKeil¿ª·¢»·¾³ÏÂÇëÑ¡ÔñIntelµÄ8058Ð¾Æ¬ÐÍºÅ½øÐÐ±àÒë
  14          //ÈôÎÞÌØ±ðËµÃ÷,¹¤×÷ÆµÂÊÒ»°ãÎª11.0592MHz
  15          
  16          
  17          #include "STC15W4K58S4.h"
  18          #include "DHT11.h"
  19          
  20          #include "intrins.h"
  21          #include <string.h>  // ×Ö·û´®´¦ÀíÍ·ÎÄ¼þ
  22          
  23          sbit LED = P3 ^ 2;  // LED
  24          sbit Buzzer = P5 ^ 4;  // ·äÃùÆ÷  ¼ÇµÃÓÃÒ»¸öÈý¼«¹ÜÇý¶¯Å¶
  25          
  26          bit busy;
  27          
  28          typedef char I8;
  29          typedef int I16;
  30          typedef long I32;
  31          typedef unsigned char U8; 
  32          
  33          U8 SRCHeader = 0x23;
  34          U8 xdata SRCCID[] = {"SRC00000000000004"};
  35          U8 xdata netConfig[] = "AT+CWJAP=\"Gunter\",\"{qwerty123}\"\r\n\0";
  36          U8 xdata DATA_GET[500]={0};//»º³åÇø³¤¶È
  37          
  38          U8 CURRENT_LENGTH=0;
  39          
  40          static   unsigned int   Timer4_Count=1;
  41          static   unsigned int   Timeout_Count=0;
  42          
  43          
  44          
  45          #define FOSC 11059200L          //ÏµÍ³ÆµÂÊ
  46          #define BAUD 115200             //´®¿Ú²¨ÌØÂÊ
  47          
  48          #define S1_S0 0x40              //P_SW1.6
  49          #define S1_S1 0x80              //P_SW1.7
  50          
  51          
  52          void DELAY_MS(unsigned int timeout);    //@11.0592MHz   1ms
  53          void DELAY_1MS() ;
  54          void UART_TC (unsigned char *str);
C51 COMPILER V8.02   SMARTCAR                                                              07/12/2020 13:06:10 PAGE 2   

  55          void UART_T (unsigned char UART_data); //¶¨Òå´®¿Ú·¢ËÍÊý¾Ý±äÁ¿
  56          void UART_R();//½ÓÊÜÊý¾Ý
  57          void ConnectServer();//Á¬½Ó·þÎñÆ÷
  58          void ReConnectServer();//ÖØÆôWIFIÁ¬½Ó·þÎñÆ÷
  59          void USART_Init();
  60          void Device_Init();
  61          void SendAckData(U8 len, unsigned char *RES_DATA);
  62          void ConnectSuccess();
  63          void Timer4Init();
  64          unsigned char CheckBCC(unsigned char len, unsigned char *recv);
  65          void ResponseData(unsigned char len,unsigned char *RES_DATA);
  66          void Buzzer_Actions_Status(unsigned char status);
  67          void Led_Actions_Status(unsigned char status);
  68          void Timer0Init(void);
  69          
  70          
  71          void main(){
  72   1          P0M0 = 0x00;
  73   1          P0M1 = 0x00;
  74   1          P1M0 = 0x00;
  75   1          P1M1 = 0x00;
  76   1          P2M0 = 0x00;
  77   1          P2M1 = 0x00;
  78   1          P3M0 = 0x00;
  79   1          P3M1 = 0x00;
  80   1          P4M0 = 0x00;
  81   1          P4M1 = 0x00;
  82   1          P5M0 = 0x00;
  83   1          P5M1 = 0x00;
  84   1          P6M0 = 0x00;
  85   1          P6M1 = 0x00;
  86   1          P7M0 = 0x00;
  87   1          P7M1 = 0x00;
  88   1          
  89   1      
  90   1          Device_Init();//³õÊ¼»¯Ó²¼þ
  91   1      
  92   1          USART_Init();//³õÊ¼»¯ÓëWiFiÍ¨ÐÅµÄ´®¿Ú
  93   1          
  94   1          if(PCON&0x10){  //Èç¹ûÊÇÓ²Æô¶¯(ÉÏµçÆô¶¯)µÄ»°£¬¾Í½øÐÐWiFiµÄµÚÒ»´Î³õÊ¼»¯²Ù×÷£¬ÈôÊÇÈÈÆô¶¯£¨¸´Î»Æô¶¯»ò¿´ÃÅ¹·Æ
             -ô¶¯£©µÄ»°Ö±½ÓÌø¹ý£»ÒòÎªWiFiÔÚµÚÒ»´Î³õÊ¼»¯µÄÊ±ºò£¬¾Í½øÐÐÁË¡° ±£´æTCPÁ¬½Óµ½flash£¬ÊµÏÖÉÏµçÍ¸´«¡±
  95   2            PCON&=0xef;
  96   2            ConnectServer();
  97   2          }
  98   1      
  99   1          
 100   1      
 101   1          ConnectSuccess();
 102   1          
 103   1          Timer4Init();
 104   1          Timer0Init();
 105   1      
 106   1          WDT_CONTR = 0x06;       //¿´ÃÅ¹·¶¨Ê±Æ÷Òç³öÊ±¼ä¼ÆËã¹«Ê½: (12 * 32768 * PS) / FOSC (Ãë)
 107   1                                  //ÉèÖÃ¿´ÃÅ¹·¶¨Ê±Æ÷·ÖÆµÊýÎª32,Òç³öÊ±¼äÈçÏÂ:
 108   1                                  //11.0592M : 1.14s
 109   1                                  //18.432M  : 0.68s
 110   1                                  //20M      : 0.63s
 111   1          WDT_CONTR |= 0x20;      //Æô¶¯¿´ÃÅ¹·  STCµ¥Æ¬»úµÄ¿´ÃÅ¹·Ò»µ©Æô¶¯ºó£¬¾ÍÃ»·¨¹Ø±Õ
 112   1      
 113   1          while(1) {
 114   2            WDT_CONTR |= 0x10;  //Î¹¹·³ÌÐò
 115   2            
C51 COMPILER V8.02   SMARTCAR                                                              07/12/2020 13:06:10 PAGE 3   

 116   2            if(DHT11_Read_Data(&DATA_Temphui[0],&DATA_Temphui[1])==0)//ÎÂÊª¶È¼ì²â
 117   2            {
 118   3              
 119   3               DATA_Temphui[2]=1;  
 120   3            }
 121   2          
 122   2      
 123   2          };
 124   1      }
 125          
 126          unsigned char CheckBCC(unsigned char len, unsigned char *recv){
 127   1          unsigned char bcc = 0x00;
 128   1          unsigned char i=0;
 129   1          for(i=0;i<len-1;i++)
 130   1          {
 131   2              bcc^=recv[i];
 132   2          };
 133   1          return bcc;
 134   1      
 135   1      }
 136          
 137          void ResponseData(unsigned char len,unsigned char *RES_DATA) {
 138   1        
 139   1        if(len <26){
 140   2          return ;
 141   2        }
 142   1      
 143   1      
 144   1      //Ð£ÑéºÍ
 145   1        if(CheckBCC(len, RES_DATA) == RES_DATA[len-1]){
 146   2        
 147   2           unsigned int dataCmdFlag =(RES_DATA[2] << 8) | RES_DATA[3];         //ÃüÁî±êÊ¶
 148   2           unsigned char dataCmdAck = RES_DATA[4];          //Ó¦´ð±êÊ¶
 149   2           unsigned char j=0;
 150   2           unsigned char dataEncryptFlag = RES_DATA[22];    //¼ÓÃÜ·½Ê½
 151   2           unsigned char dataUintLength = (RES_DATA[23] << 8) | RES_DATA[24];  //Êý¾Ý³¤¶È
 152   2           unsigned char xdata  dataTimestamp[6] = {0x00,0x00,0x00,0x00,0x00,0x00};  //Ê±¼äÊý¾Ý
 153   2      
 154   2         //Ð£ÑéCIDÊÇ·ñÕýÈ·
 155   2           for(j=5;j<22;j++){
 156   3              if(SRCCID[j-5] != RES_DATA[j]){
 157   4               return;
 158   4             }
 159   3           }
 160   2          
 161   2           //Ð£Ñé³¤¶ÈÊÇ·ñÕýÈ·
 162   2           if ((26 + dataUintLength) != len) {
 163   3              return ;
 164   3           }
 165   2           
 166   2           Timeout_Count = 0;//½«±¾µØµÄ30sÖØÁ¬¼ÆÊýÇåÁã
 167   2           
 168   2           //±£´æÊ±¼ä
 169   2           for(j=0;j<6;j++){
 170   3             dataTimestamp[j] = RES_DATA[25+j];
 171   3           }
 172   2           
 173   2           if(dataCmdFlag == 0x8001){//Á¬½ÓÈÏÖ¤
 174   3             
 175   3           }else if(dataCmdFlag ==0x8002){//ÊµÊ±ÐÅÏ¢Ö÷¶¯ÉÏ±¨
 176   3             
 177   3           }else if(dataCmdFlag ==0x8003){//²¹·¢
C51 COMPILER V8.02   SMARTCAR                                                              07/12/2020 13:06:10 PAGE 4   

 178   3             
 179   3           }else if(dataCmdFlag ==0x8004){//Éè±¸µÇ³ö
 180   3             
 181   3           }else if(dataCmdFlag ==0x8005){//ÐÄÌø
 182   3             
 183   3           }else if(dataCmdFlag ==0x8006){//Ô¶³Ì¿ØÖÆ
 184   3      
 185   3             if(RES_DATA[31] == 0x02){//»ù´¡Êý¾Ý²éÑ¯  ÎÂ¶È¡¢Êª¶È¡¢µÆ¡¢À®°È£»Çë¼û¡¾ÐÅÏ¢Ìå¶¨Òå¡¿
 186   4                unsigned char  light_status = LED ? 0x02 : 0x01;
 187   4                unsigned char buzzy_status = Buzzer ? 0x02 : 0x01;
 188   4                unsigned char xdata ds[37] = {0};
 189   4                unsigned char dslen =37;
 190   4                unsigned char j=0;
 191   4              
 192   4                ds[0] = 0X23;//Êý¾ÝÍ·
 193   4                ds[1] = 0X23;
 194   4                ds[2] = 0X10;//ÃüÁî±êÊ¶  ÏÂ·¢0x8006  ¶ÔÓÚµÄÉÏ´«ÊÇ0x1006
 195   4                ds[3] = 0X06;
 196   4                
 197   4                if(dataCmdAck == 0xFE){//Ó¦´ð±êÊ¶
 198   5                  ds[4] = 0x01;//³É¹¦
 199   5                  
 200   5                }
 201   4            
 202   4               for(j=0;j<17;j++){//CID¸³Öµ
 203   5                  ds[j+5] = SRCCID[j];
 204   5               }
 205   4              ds[22] = 0X01;//²»¼ÓÃÜ
 206   4              ds[23] = 0X00;//³¤¶ÈÁ½Î» ¸ßÎ»00
 207   4              ds[24] = 0X0B;//µÍÎ»0B Ò»¹²11Î»
 208   4      
 209   4              ds[25] = 0X14;//Äê 0x14+2000 = 2020 
 210   4              ds[26] = 0X05;//ÔÂ 
 211   4              ds[27] = 0X18;//ÈÕ 
 212   4              ds[28] = 0X15;//Ê± 
 213   4              ds[29] = 0X24;//·Ö
 214   4              ds[30] = 0X08;//Ãë
 215   4              
 216   4              ds[31] = 0X02;//»ù´¡²éÑ¯   ±àÂë
 217   4      
 218   4      
 219   4                ds[32] = DATA_Temphui[0]; //»ù´¡Êý¾Ý4¸ö×Ö½ÚµÄÊý¾Ý
 220   4                ds[33] = DATA_Temphui[1];
 221   4                ds[34] = light_status;
 222   4                ds[35] = buzzy_status;
 223   4                
 224   4            
 225   4                
 226   4               ds[dslen-1] = CheckBCC(dslen, ds);//¼ÆËãÐ£ÑéºÍ  ·Å×îºóÒ»Î»
 227   4                  SendAckData(dslen,ds);
 228   4      
 229   4               
 230   4               
 231   4             }else if(RES_DATA[31] == 0x03){//»ù´¡¿ØÖÆ  µÆ¡¢À®°È£»Çë¼û¡¾ÐÅÏ¢Ìå¶¨Òå¡¿
 232   4                     
 233   4                 unsigned char light = RES_DATA[32];
 234   4                 unsigned char buzzy = RES_DATA[33];
 235   4             
 236   4                 if( light==0x02){
 237   5                    Led_Actions_Status(0);
 238   5                  }else if( light==0x01){
 239   5                    Led_Actions_Status(1);
C51 COMPILER V8.02   SMARTCAR                                                              07/12/2020 13:06:10 PAGE 5   

 240   5                  }
 241   4                 
 242   4                 if( buzzy==0x02){
 243   5                    Buzzer_Actions_Status(0);
 244   5                 }else if( buzzy==0x01){
 245   5                    Buzzer_Actions_Status(1);
 246   5                 }
 247   4                 
 248   4                 
 249   4                 
 250   4                 
 251   4                RES_DATA[0] = 0X23;
 252   4                RES_DATA[1] = 0X23;
 253   4                RES_DATA[2] = 0X10;
 254   4                RES_DATA[3] = 0X06;
 255   4      
 256   4                if(dataCmdAck == 0xFE){
 257   5                  RES_DATA[4] = 0x01;//³É¹¦
 258   5                
 259   5                }
 260   4                if(dataCmdAck == 0xFE){//Ó¦´ð±êÊ¶
 261   5                  RES_DATA[4] = 0x01;//³É¹¦
 262   5                  
 263   5                }
 264   4            
 265   4               for(j=0;j<17;j++){//CID¸³Öµ
 266   5                  RES_DATA[j+5] = SRCCID[j];
 267   5               }
 268   4              RES_DATA[22] = 0X01;//²»¼ÓÃÜ
 269   4              RES_DATA[23] = 0X00;//³¤¶ÈÁ½Î» ¸ßÎ»00
 270   4              RES_DATA[24] = 0X09;//µÍÎ»09 Ò»¹²9Î»    6Î»µÄÊ±¼ä+1Î»µÄÃüÁî±êÊ¶ + 2Î»µÄÊý¾Ý
 271   4      
 272   4              RES_DATA[25] = 0X14;//Äê 0x14+2000 = 2020 
 273   4              RES_DATA[26] = 0X05;//ÔÂ 
 274   4              RES_DATA[27] = 0X18;//ÈÕ 
 275   4              RES_DATA[28] = 0X15;//Ê± 
 276   4              RES_DATA[29] = 0X24;//·Ö
 277   4              RES_DATA[30] = 0X08;//Ãë
 278   4              
 279   4              RES_DATA[31] = 0X03;//»ù´¡¿ØÖÆ  µÆ¡¢À®°È£»Çë¼û¡¾ÐÅÏ¢Ìå¶¨Òå¡¿
 280   4              
 281   4      //        RES_DATA[32] = RES_DATA[32];// ÕâÁ½Î»²»ÓÃ¸Ä¶¯  
 282   4      //        RES_DATA[33] = RES_DATA[33];
 283   4              
 284   4              
 285   4                  RES_DATA[len-1] = CheckBCC(len, RES_DATA);//ÕâÒ»Ö¡Êý¾Ý 35¸ö×Ö½Ú len=35
 286   4                  SendAckData(len,RES_DATA);
 287   4      
 288   4             
 289   4             }else if(RES_DATA[31] == 0x7F){//ÖØÆô
 290   4                IAP_CONTR = 0X20;
 291   4             }
 292   3             
 293   3             
 294   3             
 295   3           }
 296   2           
 297   2          
 298   2        }
 299   1        
 300   1      }
 301          
C51 COMPILER V8.02   SMARTCAR                                                              07/12/2020 13:06:10 PAGE 6   

 302          
 303          
 304          void DELAY_1MS() {
 305   1          unsigned char i, j;
 306   1      
 307   1          _nop_();
 308   1          _nop_();
 309   1          _nop_();
 310   1          i = 11;
 311   1          j = 190;
 312   1          do
 313   1          {
 314   2              while (--j);
 315   2          } while (--i);
 316   1      
 317   1      
 318   1      }
 319          
 320          void DELAY_MS(unsigned int timeout)   //@11.0592MHz
 321          {
 322   1          int t = 0;
 323   1          while (t < timeout)
 324   1          {
 325   2              t++;
 326   2              DELAY_1MS();
 327   2          }
 328   1      }
 329          
 330          
 331          
 332          //³õÊ¼»¯LEDºÍ·äÃùÆ÷
 333          void Device_Init() {
 334   1      
 335   1          LED = 0;
 336   1          Buzzer = 0;
 337   1      }
 338          
 339          //³õÊ¼»¯Íê³ÉµÎµÎÁ½Éù
 340          void ConnectSuccess(){
 341   1      
 342   1         LED = 1;
 343   1        // Buzzer = 1;
 344   1         DELAY_MS(200);
 345   1          LED = 0;
 346   1        //  Buzzer = 0;
 347   1         DELAY_MS(200);
 348   1          LED = 1;
 349   1        //  Buzzer = 1;
 350   1         DELAY_MS(200);
 351   1          LED = 0;
 352   1        //  Buzzer = 0;
 353   1      
 354   1      }
 355          
 356          
 357          void USART_Init()
 358          {
 359   1      
 360   1      //   ACC = P_SW1;
 361   1      //    ACC &= ~(S1_S0 | S1_S1);    //S1_S0=0 S1_S1=0
 362   1      //    P_SW1 = ACC;                //(P3.0/RxD, P3.1/TxD)
 363   1      
C51 COMPILER V8.02   SMARTCAR                                                              07/12/2020 13:06:10 PAGE 7   

 364   1          ACC = P_SW1;
 365   1          ACC &= ~(S1_S0 | S1_S1);    //S1_S0=1 S1_S1=0
 366   1          ACC |= S1_S0;               //(P3.6/RxD_2, P3.7/TxD_2)
 367   1          P_SW1 = ACC;
 368   1          SCON = 0x50;                //8Î»¿É±ä²¨ÌØÂÊ
 369   1          PS = 1;
 370   1          
 371   1      //  ACC = P_SW1;
 372   1      //  ACC &= ~(S1_S0 | S1_S1);    //S1_S0=0 S1_S1=1
 373   1      //  ACC |= S1_S1;               //(P1.6/RxD_3, P1.7/TxD_3)
 374   1      //  P_SW1 = ACC;
 375   1      
 376   1      
 377   1          AUXR = 0x40;                //¶¨Ê±Æ÷1Îª1TÄ£Ê½
 378   1          TMOD = 0x00;                //¶¨Ê±Æ÷1ÎªÄ£Ê½0(16Î»×Ô¶¯ÖØÔØ)
 379   1          TL1 = (65536 - (FOSC/4/BAUD));   //ÉèÖÃ²¨ÌØÂÊÖØ×°Öµ
 380   1          TH1 = (65536 - (FOSC/4/BAUD))>>8;
 381   1          TR1 = 1;                    //¶¨Ê±Æ÷1¿ªÊ¼Æô¶¯
 382   1          ES = 1;                     //Ê¹ÄÜ´®¿ÚÖÐ¶Ï
 383   1          EA = 1;
 384   1      
 385   1      }
 386          
 387          /*----------------------------
 388          UART ÖÐ¶Ï·þÎñ³ÌÐò
 389          -----------------------------*/
 390          void Uart() interrupt 4 using 1
 391          {
 392   1          if (RI)
 393   1          {
 394   2              while(!RI);
 395   2              RI=0;
 396   2              UART_R();
 397   2              busy = 0;
 398   2      
 399   2          }
 400   1          if (TI)
 401   1          {
 402   2              while(!TI);
 403   2              TI = 0;                 //Çå³ýTIÎ»
 404   2              busy = 0;               //ÇåÃ¦±êÖ¾
 405   2          }
 406   1      }
 407          
 408          
 409          void UART_T (unsigned char UART_data) { //¶¨Òå´®¿Ú·¢ËÍÊý¾Ý±äÁ¿
 410   1          SBUF = UART_data; //½«½ÓÊÕµÄÊý¾Ý·¢ËÍ»ØÈ¥
 411   1          while(!TI);   //¼ì²é·¢ËÍÖÐ¶Ï±êÖ¾Î»
 412   1          TI = 0;     //Áî·¢ËÍÖÐ¶Ï±êÖ¾Î»Îª0£¨Èí¼þÇåÁã£©
 413   1      }
 414          
 415          
 416          void UART_TC (unsigned char *str) {
 417   1          while(*str != '\0') {
 418   2              UART_T(*str);
 419   2              *str++;
*** WARNING C275 IN LINE 419 OF ..\CODE\SMARTCAR.C: expression with possibly no effect
 420   2          }
 421   1          *str = 0;
 422   1      }
 423          
 424          
C51 COMPILER V8.02   SMARTCAR                                                              07/12/2020 13:06:10 PAGE 8   

 425          //´®¿Ú  ½ÓÊÕESP8266µÄ´®¿ÚÊý¾Ý£¬²¢Ð£ÑéÊý¾ÝµÄÍêÕûÐÔ9Î»
 426          
 427          void UART_R()
 428          {
 429   1          TL0 = 0x00;   //ÉèÖÃ¶¨Ê±³õÖµ
 430   1        TH0 = 0xDC;   //ÉèÖÃ¶¨Ê±³õÖµ
 431   1        TF0 = 0;    //Çå³ýTF0±êÖ¾
 432   1        TR0 = 1;    //¶¨Ê±Æ÷0¿ªÊ¼¼ÆÊ±
 433   1        ET0 = 1;  //ÔÊÐíÖÐ¶Ï
 434   1        
 435   1        
 436   1      
 437   1         DATA_GET[CURRENT_LENGTH]=SBUF;
 438   1         CURRENT_LENGTH++;
 439   1        
 440   1        
 441   1      
 442   1      }
 443          
 444          
 445          
 446          void SendAckData(U8 len, unsigned char *RES_DATA) {
 447   1        
 448   1          unsigned int i=0;
 449   1          for(i=0; i<len; i++)
 450   1          {
 451   2               
 452   2              SBUF=RES_DATA[i];
 453   2              while(!TI);   //¼ì²é·¢ËÍÖÐ¶Ï±êÖ¾Î»
 454   2                TI = 0; 
 455   2          }
 456   1      }
 457          
 458          //ÖØÆô ESP8266WiFiÄ£¿é
 459          void ReConnectServer() {
 460   1      
 461   1          UART_TC("+++\0"); // ÍË³öÍ¸´«Ä£Ê½
 462   1           DELAY_MS( 1000);
 463   1          UART_TC("AT+RST\r\n\0");  // ¸´Î»
 464   1          
 465   1      }
 466          
 467          //³õÊ¼»¯ESP8266WiFiÄ£¿é£¬²¢Á¬½Óµ½·þÎñÆ÷
 468          void ConnectServer() {
 469   1      
 470   1          DELAY_MS( 1000);
 471   1      
 472   1          UART_TC("+++\0"); // ÍË³öÍ¸´«Ä£Ê½
 473   1          DELAY_MS( 1000);
 474   1          
 475   1          UART_TC("AT+CWMODE=1\r\n\0"); // ÕâÊÇÉèÖÃSTAÄ£Ê½
 476   1          DELAY_MS( 2500);
 477   1          
 478   1          UART_TC("AT+CIPMUX=0\r\n\0");  // ÉèÖÃµ¥Á¬½ÓÄ£Ê½
 479   1          DELAY_MS(1000);
 480   1      
 481   1          UART_TC(netConfig);  // ÕâÒ»²½±ãÊÇÁ¬½Ówifi£¬ÑÓÊ±µÄÊ±¼äÒª³¤Ò»Ð©£¬·ñÔò»áµÈ²»µ½·µ»ØµÄÐÅÏ¢¡£10s
 482   1          DELAY_MS(15000);
 483   1      
 484   1      
 485   1          UART_TC("AT+CIPSTART=\"TCP\",\"47.104.19.111\",4001\r\n\0");  // Á¬½Óµ½Ö¸¶¨TCP·þÎñÆ÷192.168.0.2
 486   1          DELAY_MS( 5000);
C51 COMPILER V8.02   SMARTCAR                                                              07/12/2020 13:06:10 PAGE 9   

 487   1      
 488   1          UART_TC("AT+CIPMODE=1\r\n\0"); // ÉèÖÃÍ¸´«Ä£Ê½
 489   1          DELAY_MS( 2000);
 490   1      
 491   1         UART_TC("AT+SAVETRANSLINK=1,\"47.104.19.111\",4001,\"TCP\"\r\n\0"); // ±£´æTCPÁ¬½Óµ½flash£¬ÊµÏÖÉÏµçÍ¸´«
 492   1         DELAY_MS(1000);
 493   1      
 494   1          UART_TC("AT+CIPSEND\r\n\0");   // ½øÈëÍ¸´«Ä£Ê½ ×¼±¸Ä£¿éÓëµçÄÔ½øÐÐ»¥´«Êý¾Ý
 495   1          DELAY_MS( 1000);
 496   1          
 497   1          
 498   1      
 499   1      }
 500          
 501          void Timer4Init(void)   
 502          {
 503   1        //50 ºÁÃë@11.0592MHz
 504   1        T4T3M &= 0xDF;    //¶¨Ê±Æ÷Ê±ÖÓ12TÄ£Ê½
 505   1        T4L = 0x00;   //ÉèÖÃ¶¨Ê±³õÖµ
 506   1        T4H = 0x4C;   //ÉèÖÃ¶¨Ê±³õÖµ
 507   1        T4T3M |= 0x80;    //¶¨Ê±Æ÷4¿ªÊ¼¼ÆÊ±
 508   1        
 509   1          IE2 |= 0x40;    //¿ª¶¨Ê±Æ÷4ÖÐ¶Ï
 510   1          EA=1;   //×ÜÖÐ¶Ï¿ªÆô
 511   1      }
 512          
 513          
 514          //10sÖÐ¶Ï×Ô¶¯ÉÏ±¨ÐÅÏ¢
 515          void Timer4_interrupt() interrupt 20    //¶¨Ê±ÖÐ¶ÏÈë¿Ú
 516          {
 517   1        
 518   1      
 519   1          if(Timer4_Count>=200){  //200 * 50ms = 10s
 520   2                unsigned char j=0;
 521   2                U8 xdata RES_DATA[37]= {0};
 522   2                unsigned char RES_LEN= 37;
 523   2                unsigned char  light_status = LED ? 0x02 : 0x01;
 524   2                unsigned char buzzy_status = Buzzer ? 0x02 : 0x01;
 525   2                Timer4_Count = 1;
 526   2      
 527   2                RES_DATA[0] = 0X23;//Êý¾ÝÍ·
 528   2                RES_DATA[1] = 0X23;
 529   2                RES_DATA[2] = 0X10;//ÃüÁî±êÊ¶  ÏÂ·¢0x8006  ¶ÔÓÚµÄÉÏ´«ÊÇ0x1006
 530   2                RES_DATA[3] = 0X06;
 531   2                RES_DATA[4] = 0xFE;//Ó¦´ð±êÊ¶
 532   2                  
 533   2               for(j=0;j<17;j++){//CID¸³Öµ
 534   3                  RES_DATA[j+5] = SRCCID[j];
 535   3               }
 536   2               
 537   2              RES_DATA[22] = 0X01;//²»¼ÓÃÜ
 538   2              RES_DATA[23] = 0X00;//³¤¶ÈÁ½Î» ¸ßÎ»00
 539   2              RES_DATA[24] = 0X0B;//µÍÎ»0B Ò»¹²11Î»
 540   2      
 541   2              RES_DATA[25] = 0X14;//Äê 0x14+2000 = 2020 
 542   2              RES_DATA[26] = 0X05;//ÔÂ 
 543   2              RES_DATA[27] = 0X18;//ÈÕ 
 544   2              RES_DATA[28] = 0X15;//Ê± 
 545   2              RES_DATA[29] = 0X24;//·Ö
 546   2              RES_DATA[30] = 0X08;//Ãë
 547   2              
 548   2              RES_DATA[31] = 0X02;//»ù´¡Êý¾ÝÉÏ±¨
C51 COMPILER V8.02   SMARTCAR                                                              07/12/2020 13:06:10 PAGE 10  

 549   2      
 550   2      
 551   2      //      if(DATA_Temphui[2]==1)
 552   2      //      {
 553   2      //          DATA_Temphui[2]=0;//¸´Î»½«Æä  ÓÃÓÚ¼ì²âÊÇ·ñÊÕµ½Êý¾Ý
 554   2      //      }
 555   2      
 556   2            RES_DATA[32] = DATA_Temphui[0];
 557   2            RES_DATA[33] =  DATA_Temphui[1];
 558   2            RES_DATA[34] = light_status;
 559   2            RES_DATA[35] = buzzy_status,
 560   2            RES_DATA[RES_LEN-1] = CheckBCC(RES_LEN, RES_DATA);
 561   2                
 562   2            Timeout_Count++;//Ã¿¼ÓÒ»´Î¼Ó10s
 563   2            
 564   2            if(Timeout_Count < 3){
 565   3              SendAckData(RES_LEN,RES_DATA);
 566   3          }else if(Timeout_Count >= 3){//1min ÖØÆô»úÆ÷
 567   3              //UART_TC("+++\0"); // ÍË³öÍ¸´«Ä£Ê½
 568   3              
 569   3              ReConnectServer();
 570   3              Timeout_Count = 0;
 571   3            
 572   3            }//else   if(Timeout_Count > 3){
 573   2      //            Timeout_Count = 0;
 574   2      //            UART_TC("AT+RST\r\n\0");  // ¸´Î»
 575   2      //          //  IAP_CONTR = 0X20;
 576   2      //        }
 577   2              
 578   2            
 579   2          }else{
 580   2            
 581   2              Timer4_Count++;
 582   2          }
 583   1          
 584   1      }
 585          
 586          
 587          
 588          
 589          
 590          void Timer0Init(void)   //10ºÁÃë@11.0592MHz
 591          {
 592   1        AUXR &= 0x7F;   //¶¨Ê±Æ÷Ê±ÖÓ12TÄ£Ê½
 593   1        TMOD &= 0xF0;   //ÉèÖÃ¶¨Ê±Æ÷Ä£Ê½
 594   1        TMOD |= 0x01;   //ÉèÖÃ¶¨Ê±Æ÷Ä£Ê½
 595   1        TL0 = 0x00;   //ÉèÖÃ¶¨Ê±³õÖµ
 596   1        TH0 = 0xB8;   //ÉèÖÃ¶¨Ê±³õÖµ
 597   1        TF0 = 0;    //Çå³ýTF0±êÖ¾
 598   1        TR0 = 1;    //¶¨Ê±Æ÷0¿ªÊ¼¼ÆÊ±
 599   1        ET0 = 1;  //ÔÊÐíÖÐ¶Ï
 600   1      }
 601          
 602          
 603          
 604          /********************* Timer0ÖÐ¶Ïº¯Êý************************/
 605          void timer0_int (void) interrupt 1
 606          {
 607   1        TL0 = 0x00;   //ÉèÖÃ¶¨Ê±³õÖµ
 608   1        TH0 = 0xB8;   //ÉèÖÃ¶¨Ê±³õÖµ
 609   1        TF0 = 0;    //Çå³ýTF0±êÖ¾
 610   1        TR0 = 0;    //¶¨Ê±Æ÷0¿ªÊ¼¼ÆÊ±
C51 COMPILER V8.02   SMARTCAR                                                              07/12/2020 13:06:10 PAGE 11  

 611   1        ET0 = 0;  //ÔÊÐíÖÐ¶Ï
 612   1        
 613   1        ResponseData(CURRENT_LENGTH,DATA_GET);    
 614   1        CURRENT_LENGTH = 0;
 615   1            
 616   1      }
 617          
 618          
 619          void Led_Actions_Status(unsigned char status){
 620   1      
 621   1        if(status){
 622   2          LED = 0;
 623   2        }else{
 624   2          LED = 1;
 625   2        }
 626   1      
 627   1      }
 628          
 629          void Buzzer_Actions_Status(unsigned char status){
 630   1      
 631   1        if(status){
 632   2          Buzzer = 0;
 633   2        }else{
 634   2          Buzzer = 1;
 635   2        }
 636   1      
 637   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =   1874    ----
   CONSTANT SIZE    =    246    ----
   XDATA SIZE       =    553      80
   PDATA SIZE       =   ----    ----
   DATA SIZE        =      6      25
   IDATA SIZE       =   ----    ----
   BIT SIZE         =      1    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  1 WARNING(S),  0 ERROR(S)
